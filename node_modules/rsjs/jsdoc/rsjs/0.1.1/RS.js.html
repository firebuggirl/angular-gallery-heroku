<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: RS.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: RS.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

require('v8-promise');

module.exports = RS;

/**
 * @class Reactive Stream.
 * @param {function} subscriber
 */
function RS(subscriber) {
  if (typeof subscriber !== 'function') throw TypeError
    ('Subscriber is not a function: ' + subscriber);

  this._subscriber = subscriber;
}

/**
 * Subscribe observer on stream.
 * @memberof RS#
 * @param {Object} observer
 * @return {Subscription}
 */
function subscribe(observer) {
  if (observer !== Object(observer)) throw TypeError
    ('Observer is not an object: ' + observer);

  var subscription = new Subscription, error, unsub,
      control = new Control(observer, subscription);

  try {
    unsub = this._subscriber.call(undefined, control);
  } catch (e) { error = e; }

  if (unsub != null) {
    if (typeof unsub.unsubscribe === 'function' ||
        typeof unsub === 'function') {

      if (subscription._unsub) {
          subscription._unsub = unsub;
      } else {
          typeof unsub.unsubscribe === 'function' ?
            unsub.unsubscribe() : unsub();
      }

    } else {
      error = TypeError('Object has no method unsubscribe: ' + unsub);
    }
  }

  if (error) control.error(error);

  return subscription;
}

/**
 * Call fn(item) for each stream item.
 * @memberof RS#
 * @param {function} fn
 * @return {Promise} Resolve when stream complete.
 */
function forEach(fn) {
  var stream = this;

  function forEachResolver(resolver, reject) {
    if (typeof fn !== 'function') throw TypeError
      ('Not a function: ' + fn);
    var observer = {
      fn: fn,
      next: _forEachNext,
      error: reject,
      complete: resolver
    };
    observer.subscription = stream.subscribe(observer);
  }

  return new Promise(forEachResolver);
}

/**
 * Next action for method forEach.
 * @param {*} value
 */
function _forEachNext(value) {
  try { return this.fn.call(undefined, value); }
  catch (e) {

    try { this.error(e); } catch (e) {}

    this.subscription.unsubscribe();
  }
}

/**
 * @class Control
 * Control stream (SubscriptionObserver).
 * @param {Object} observer
 * @param {Subscription} subscription
 */
function Control(observer, subscription) {
  this._observer = observer;
  this._subscription = subscription;
}

/**
 * Send next value to stream.
 * @memberof Control#
 * @param {*} value
 */
function next(value) {
  if (!this._subscription._unsub) return;

  var next = this._observer.next;

  try {
    if (next != null &amp;&amp; typeof next !== 'function')
      throw TypeError('Object has no method next: ' + this._observer);

    return next ? this._observer.next(value) : undefined;

  } catch (e) {
    try { this._subscription.unsubscribe(); }
    finally { throw e; }
  }
}

/**
 * Send error to stream.
 * @memberof Control#
 * @param {*} value
 */
function error(value) {
  if (!this._subscription._unsub) throw value;

  var error = this._observer.error, thrown;

  try {
    if (error != null &amp;&amp; typeof error !== 'function')
      throw TypeError('Object has no method error: ' + this._observer);

    if (error == null) throw value;

    return this._observer.error(value);

  } catch (e) { thrown = true; throw e; }
  finally {
    try { this._subscription.unsubscribe(); }
    catch (e) { if (!thrown) throw e; }
  }
}

/**
 * Send completion to stream.
 * @memberof Control#
 * @param {*} value
 */
function complete(value) {
  if (!this._subscription._unsub) return;

  var complete = this._observer.complete, thrown;

  try {
    if (complete != null &amp;&amp; typeof complete !== 'function')
      throw TypeError('Object has no method complete: ' + this._observer);

    return complete ? this._observer.complete(value) : undefined;

  } catch (e) { thrown = true; throw e; }
  finally {
    try { this._subscription.unsubscribe(); }
    catch (e) { if (!thrown) throw e; }
  }
}

/**
 * @class Subscription
 * Connects a pair of stream-listener.
 */
function Subscription() {
  this._unsub = true;
}

/**
 * Unsubscribe from stream.
 * @memberof Subscription#
 */
function unsubscribe() {
  var unsub = this._unsub;

  if (!unsub) return;

  try {
    if (unsub !== true) {
      typeof unsub === 'function' ?
        unsub() : unsub.unsubscribe();
    }
  } finally {
    this._unsub = undefined;
  }
}

/**
 * True, if already unsubscribed.
 * @memberof Subscription#
 * @return {boolean}
 */
function isUnsubscribed() {
  return !this._unsub;
}

/**
 * Define non-enumerable methods for prototype.
 * @param {Object} target
 * @param {Object} methods
 */
function defineMethods(target, methods) {
  for (var key in methods) {
    desc.value = methods[key];
    defineProperty(target, key, desc);
  }
}

function returnThis() { return this; }

var symbol = {}, symDef = typeof Symbol === 'function',
    desc = {configurable: true},
    defineProperty = Object.defineProperty;

['species', 'observable', 'iterator'].forEach(function(key) {
  symbol[key] = (symDef &amp;&amp; Symbol[key]) || '@@' + key;
});


desc.get = isUnsubscribed;
defineProperty(Subscription.prototype = {}, 'isUnsubscribed', desc);

desc.get = returnThis;
defineProperty(RS, symbol.species, desc);

desc.writable = delete desc.get;

desc.value = returnThis;
defineProperty(RS.prototype, symbol.observable, desc);

defineMethods(RS.prototype, {
  subscribe: subscribe,
  forEach: forEach
});

defineMethods(Subscription.prototype, {
  unsubscribe: unsubscribe
});

defineMethods(Control.prototype = {}, {
  next: next,
  error: error,
  complete: complete
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Control.html">Control</a></li><li><a href="RS.html">RS</a></li><li><a href="Subscription.html">Subscription</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_forEachNext">_forEachNext</a></li><li><a href="global.html#defineMethods">defineMethods</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sun May 22 2016 10:48:13 GMT+0300 (MSK)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
